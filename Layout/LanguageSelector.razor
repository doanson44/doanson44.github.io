@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Client.Services
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject CultureService CultureService

<div class="language-selector">
    <select value="@SelectedCulture" @onchange="OnCultureChanged" class="form-select form-select-sm">
        <option value="en-US">English</option>
        <option value="vi-VN">Tiếng Việt</option>
    </select>
</div>

@code {
    private string SelectedCulture
    {
        get => CultureInfo.CurrentCulture.Name;
        set
        {
            if (value != CultureInfo.CurrentCulture.Name)
            {
                // Set culture using service
                CultureService.SetCultureAsync(value).ContinueWith(_ =>
                {
                    // Reload the page to apply the new culture
                    Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
                });
            }
        }
    }

    private void OnCultureChanged(ChangeEventArgs e)
    {
        SelectedCulture = e.Value?.ToString() ?? "en-US";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load culture from localStorage on first render
            var storedCulture = await CultureService.GetStoredCultureAsync();
            if (!string.IsNullOrEmpty(storedCulture) && storedCulture != CultureInfo.CurrentCulture.Name)
            {
                await CultureService.SetCultureAsync(storedCulture);
                // Reload to apply
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
        }
    }
}