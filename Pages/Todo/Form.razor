@page "/todos/new"
@page "/todos/edit/{Id:guid}"
@using Client.Common.CQRS
@using Client.Common
@using Client.Modules.TodoModule.Commands
@using Client.Modules.TodoModule.Queries
@using Client.Models
@using Client.Services
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>@pageTitle</PageTitle>

<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@pageTitle</h1>
        <RadzenButton Text="Back to List" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@(() => Navigation.NavigateTo("/todos"))" />
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="form-section">
                @if (isLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }
                else
                {
                    <!-- 
                        Radzen form with CQRS command
                        - Form is bound to a command object (CreateTodoCommand or UpdateTodoCommand)
                        - Uses DataAnnotations for validation
                        - Command is executed through command handler on submit
                    -->
                    <RadzenTemplateForm TItem="CreateTodoCommand" Data="@command" Submit="@HandleSubmit">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <RadzenLabel Text="Title" Component="Title" class="form-label" />
                                <RadzenTextBox @bind-Value="@command.Title" Name="Title" class="w-100" Placeholder="Enter todo title" />
                                <RadzenRequiredValidator Component="Title" Text="Title is required" />
                                <RadzenLengthValidator Component="Title" Max="100" Text="Title cannot exceed 100 characters" />
                            </div>

                            <div class="col-12 mb-3">
                                <RadzenLabel Text="Description" Component="Description" class="form-label" />
                                <RadzenTextArea @bind-Value="@command.Description" Name="Description" class="w-100" Rows="4" Placeholder="Enter description (optional)" />
                                <RadzenLengthValidator Component="Description" Max="500" Text="Description cannot exceed 500 characters" />
                            </div>

                            <div class="col-12 mb-4">
                                <RadzenLabel Text="Priority" Component="Priority" class="form-label" />
                                <RadzenDropDown @bind-Value="@command.Priority" 
                                                Data="@priorities" 
                                                Name="Priority" 
                                                class="w-100" 
                                                Placeholder="Select priority" />
                                <RadzenRequiredValidator Component="Priority" Text="Priority is required" />
                            </div>

                            <div class="col-12">
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <RadzenButton ButtonType="ButtonType.Button" 
                                                  Text="Cancel" 
                                                  Icon="cancel" 
                                                  ButtonStyle="ButtonStyle.Light" 
                                                  Click="@(() => Navigation.NavigateTo("/todos"))" 
                                                  class="me-md-2" />
                                    <RadzenButton ButtonType="ButtonType.Submit" 
                                                  Text="@(isEditMode ? "Update" : "Create")" 
                                                  Icon="@(isEditMode ? "save" : "add_circle")" 
                                                  ButtonStyle="ButtonStyle.Primary" 
                                                  Disabled="@isSubmitting" />
                                </div>
                            </div>
                        </div>
                    </RadzenTemplateForm>
                }
            </div>

            <!-- Info Card -->
            <RadzenCard class="mt-4">
                <h5 class="mb-3">Form Features</h5>
                <ul class="mb-0">
                    <li><strong>CQRS:</strong> Form submits CreateTodoCommand or UpdateTodoCommand</li>
                    <li><strong>Validation:</strong> DataAnnotations with Radzen validators</li>
                    <li><strong>AutoMapper:</strong> Command → Entity mapping in handler</li>
                    <li><strong>Cache:</strong> Cache invalidated after successful save</li>
                    <li><strong>Responsive:</strong> Touch-friendly on mobile devices</li>
                </ul>
            </RadzenCard>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private CreateTodoCommand command = new();
    private List<string> priorities = new();
    private bool isEditMode = false;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string pageTitle = "Add New Todo";

    protected override async Task OnInitializedAsync()
    {
        isEditMode = Id.HasValue;
        pageTitle = isEditMode ? "Edit Todo" : "Add New Todo";

        // Initialize priorities with localized strings
        priorities = new List<string> { "Low", "Medium", "High" };

        if (isEditMode && Id.HasValue)
        {
            await LoadTodo(Id.Value);
        }
        else
        {
            command.Priority = "Medium"; // Default priority
            isLoading = false;
        }
    }

    /// <summary>
    /// Loads existing todo for editing using CQRS query through mediator.
    /// </summary>
    private async Task LoadTodo(Guid id)
    {
        isLoading = true;

        try
        {
            // CQRS: Execute query to get todo by ID through mediator
            var query = new GetTodoByIdQuery(id);
            var todo = await Mediator.QueryAsync<GetTodoByIdQuery, TodoDto?>(query);

            if (todo != null)
            {
                // Map DTO to command object
                command.Title = todo.Title;
                command.Description = todo.Description;
                command.Priority = todo.Priority;
            }
            else
            {
                NotificationService.NotifyError("Not Found", "Todo not found", 3000);
                Navigation.NavigateTo("/todos");
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Handles form submission.
    /// Creates or updates todo using CQRS command handlers.
    /// Command handlers use AutoMapper to map to entities.
    /// </summary>
    private async Task HandleSubmit()
    {
        if (isSubmitting) return;

        isSubmitting = true;

        try
        {
            if (isEditMode && Id.HasValue)
            {
                // CQRS: Execute update command through mediator
                var updateCommand = new UpdateTodoCommand
                {
                    Id = Id.Value,
                    Title = command.Title,
                    Description = command.Description,
                    Priority = command.Priority,
                    IsCompleted = false // Keep existing completion status
                };

                await Mediator.SendAsync(updateCommand);

                NotificationService.NotifySuccess("Success", "Todo updated successfully", 3000);
            }
            else
            {
                // CQRS: Execute create command through mediator
                // Command handler will use AutoMapper to map CreateTodoCommand → TodoItem
                await Mediator.SendAsync(command);

                NotificationService.NotifySuccess("Success", "Todo created successfully", 3000);
            }

            // Navigate back to list with refresh trigger
            Navigation.NavigateTo($"/todos?refresh={Guid.NewGuid()}");
        }
        catch (Exception ex)
        {
            NotificationService.NotifyError("Error", $"Failed to save todo: {ex.Message}", 5000);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
