@page "/todos"
@using System
@using Client.Common.CQRS
@using Client.Common
@using Client.Modules.TodoModule.Queries
@using Client.Modules.TodoModule.Commands
@using Client.Models
@using Client.Services
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject LocalizationService Localizer

<PageTitle>@Localizer["TodoList"]</PageTitle>

<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@Localizer["TodoList"]</h1>
        <RadzenButton Text="@Localizer["AddNewTodo"]" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Click="@(() => Navigation.NavigateTo("/todos/new"))" />
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@Localizer["Loading"]</span>
            </div>
            <p class="mt-3 text-muted">@Localizer["LoadingTodos"]</p>
        </div>
    }
    else
    {
        <!-- 
            Radzen DataGrid with CQRS pattern
            - Data comes from GetTodoListQuery via query handler
            - Query handler uses ICacheService to cache results
            - AutoMapper is used internally to map entities to DTOs
        -->
        <RadzenDataGrid @ref="grid" 
                        Data="@todos" 
                        TItem="TodoDto" 
                        AllowFiltering="true" 
                        AllowSorting="true"
                        AllowPaging="true"
                        PageSize="10"
                        PagerHorizontalAlign="HorizontalAlign.Center"
                        FilterMode="FilterMode.Advanced"
                        class="shadow-sm">
            <Columns>
                <RadzenDataGridColumn TItem="TodoDto" Property="Id" Title="@Localizer["ID"]" Width="80px" TextAlign="TextAlign.Center" />
                
                <RadzenDataGridColumn TItem="TodoDto" Property="Title" Title="@Localizer["Title"]" Width="200px">
                    <Template Context="todo">
                        @if (todo.IsCompleted)
                        {
                            <span class="text-decoration-line-through text-muted">@todo.Title</span>
                        }
                        else
                        {
                            <strong>@todo.Title</strong>
                        }
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="Description" Title="@Localizer["Description"]">
                    <Template Context="todo">
                        <span class="text-truncate-2">@todo.Description</span>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="Priority" Title="@Localizer["Priority"]" Width="120px">
                    <Template Context="todo">
                        <span class="badge @GetPriorityBadgeClass(todo.Priority)">
                            @todo.Priority
                        </span>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="IsCompleted" Title="@Localizer["Status"]" Width="120px">
                    <Template Context="todo">
                        @if (todo.IsCompleted)
                        {
                            <span class="badge bg-success">@Localizer["Completed"]</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">@Localizer["Pending"]</span>
                        }
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="CreatedAt" Title="@Localizer["Created"]" Width="130px" FormatString="{0:MMM dd, yyyy}" />

                <RadzenDataGridColumn TItem="TodoDto" Title="@Localizer["Actions"]" Width="180px" Sortable="false" Filterable="false">
                    <Template Context="todo">
                        <div class="btn-group btn-group-sm" role="group">
                            @if (!todo.IsCompleted)
                            {
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" 
                                              Click="@(() => MarkAsComplete(todo))" 
                                              title="@Localizer["MarkAsComplete"]" />
                            }
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                          Click="@(() => EditTodo(todo))" 
                                          title="@Localizer["Edit"]" />
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                          Click="@(() => DeleteTodo(todo))" 
                                          title="@Localizer["Delete"]" />
                        </div>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>

        @if (!todos.Any())
        {
            <div class="alert alert-info mt-4">
                <i class="bi bi-info-circle"></i> @Localizer["NoTodosFound"]
            </div>
        }
    }
</div>

@code {
    private RadzenDataGrid<TodoDto>? grid;
    private List<TodoDto> todos = new();
    private bool isLoading = true;
    private Guid refreshTrigger = Guid.NewGuid();

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Refresh { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when parameters change (e.g., when navigating back)
        await LoadTodos();
    }

    /// <summary>
    /// Loads todos using CQRS query through mediator.
    /// The handler uses ICacheService to cache results.
    /// </summary>
    private async Task LoadTodos()
    {
        isLoading = true;

        try
        {
            // CQRS: Execute query through mediator
            var query = new GetAllTodosQuery();
            todos = await Mediator.QueryAsync<GetAllTodosQuery, List<TodoDto>>(query);
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Marks a todo as complete using CQRS command through mediator.
    /// </summary>
    private async Task MarkAsComplete(TodoDto todo)
    {
        try
        {
            // CQRS: Create and execute command through mediator
            var command = new UpdateTodoCommand
            {
                Id = todo.Id,
                Title = todo.Title,
                Description = todo.Description,
                Priority = todo.Priority,
                IsCompleted = true
            };

            await Mediator.SendAsync(command);

            NotificationService.NotifySuccess(Localizer["Success"], Localizer["TodoMarkedAsComplete"]);

            await LoadTodos();
        }
        catch (Exception ex)
        {
            NotificationService.NotifyError(Localizer["Error"], string.Format(Localizer["FailedToUpdateTodo"], ex.Message));
        }
    }

    private void EditTodo(TodoDto todo)
    {
        Navigation.NavigateTo($"/todos/edit/{todo.Id}");
    }

    /// <summary>
    /// Deletes a todo using CQRS command through mediator after confirmation.
    /// </summary>
    private async Task DeleteTodo(TodoDto todo)
    {
        var confirmed = await DialogService.Confirm(
            string.Format(Localizer["DeleteConfirmationMessage"], todo.Title),
            Localizer["ConfirmDelete"],
            new ConfirmOptions { OkButtonText = Localizer["YesDelete"], CancelButtonText = Localizer["Cancel"] }
        );

        if (confirmed == true)
        {
            try
            {
                // CQRS: Create and execute delete command through mediator
                var command = new DeleteTodoCommand(todo.Id);
                await Mediator.SendAsync(command);

                NotificationService.NotifySuccess(Localizer["Deleted"], Localizer["TodoDeletedSuccessfully"]);

                await LoadTodos();
            }
            catch (Exception ex)
            {
                NotificationService.NotifyError(Localizer["Error"], string.Format(Localizer["FailedToDeleteTodo"], ex.Message));
            }
        }
    }

    private string GetPriorityBadgeClass(string priority)
    {
        return priority switch
        {
            "High" => "bg-danger",
            "Medium" => "bg-warning text-dark",
            "Low" => "bg-success",
            _ => "bg-secondary"
        };
    }
}
