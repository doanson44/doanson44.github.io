@page "/todos"
@using System
@using Client.Common.CQRS
@using Client.Common
@using Client.Modules.TodoModule.Queries
@using Client.Modules.TodoModule.Commands
@using Client.Models
@using Client.Services
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Todo List</PageTitle>

<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Todo List</h1>
        <RadzenButton Text="Add New Todo" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Click="@(() => Navigation.NavigateTo("/todos/new"))" />
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading todos...</p>
        </div>
    }
    else
    {
        <!-- 
            Radzen DataGrid with CQRS pattern
            - Data comes from GetTodoListQuery via query handler
            - Query handler uses ICacheService to cache results
            - AutoMapper is used internally to map entities to DTOs
        -->
        <RadzenDataGrid @ref="grid" 
                        Data="@todos" 
                        TItem="TodoDto" 
                        AllowFiltering="true" 
                        AllowSorting="true"
                        AllowPaging="true"
                        PageSize="10"
                        PagerHorizontalAlign="HorizontalAlign.Center"
                        FilterMode="FilterMode.Advanced"
                        class="shadow-sm">
            <Columns>
                <RadzenDataGridColumn TItem="TodoDto" Property="Id" Title="ID" Width="80px" TextAlign="TextAlign.Center" />
                
                <RadzenDataGridColumn TItem="TodoDto" Property="Title" Title="Title" Width="200px">
                    <Template Context="todo">
                        @if (todo.IsCompleted)
                        {
                            <span class="text-decoration-line-through text-muted">@todo.Title</span>
                        }
                        else
                        {
                            <strong>@todo.Title</strong>
                        }
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="Description" Title="Description">
                    <Template Context="todo">
                        <span class="text-truncate-2">@todo.Description</span>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="Priority" Title="Priority" Width="120px">
                    <Template Context="todo">
                        <span class="badge @GetPriorityBadgeClass(todo.Priority)">
                            @todo.Priority
                        </span>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="IsCompleted" Title="Status" Width="120px">
                    <Template Context="todo">
                        @if (todo.IsCompleted)
                        {
                            <span class="badge bg-success">Completed</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Pending</span>
                        }
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="TodoDto" Property="CreatedAt" Title="Created" Width="130px" FormatString="{0:MMM dd, yyyy}" />

                <RadzenDataGridColumn TItem="TodoDto" Title="Actions" Width="180px" Sortable="false" Filterable="false">
                    <Template Context="todo">
                        <div class="btn-group btn-group-sm" role="group">
                            @if (!todo.IsCompleted)
                            {
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" 
                                              Click="@(() => MarkAsComplete(todo))" 
                                              title="Mark as Complete" />
                            }
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                          Click="@(() => EditTodo(todo))" 
                                          title="Edit" />
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                          Click="@(() => DeleteTodo(todo))" 
                                          title="Delete" />
                        </div>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>

        @if (!todos.Any())
        {
            <div class="alert alert-info mt-4">
                <i class="bi bi-info-circle"></i> No todos found. Click "Add New" to create your first todo!
            </div>
        }
    }
</div>

@code {
    private RadzenDataGrid<TodoDto>? grid;
    private List<TodoDto> todos = new();
    private bool isLoading = true;
    private Guid refreshTrigger = Guid.NewGuid();

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Refresh { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when parameters change (e.g., when navigating back)
        await LoadTodos();
    }

    /// <summary>
    /// Loads todos using CQRS query through mediator.
    /// The handler uses ICacheService to cache results.
    /// </summary>
    private async Task LoadTodos()
    {
        isLoading = true;

        try
        {
            // CQRS: Execute query through mediator
            var query = new GetAllTodosQuery();
            todos = await Mediator.QueryAsync<GetAllTodosQuery, List<TodoDto>>(query);
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Marks a todo as complete using CQRS command through mediator.
    /// </summary>
    private async Task MarkAsComplete(TodoDto todo)
    {
        try
        {
            // CQRS: Create and execute command through mediator
            var command = new UpdateTodoCommand
            {
                Id = todo.Id,
                Title = todo.Title,
                Description = todo.Description,
                Priority = todo.Priority,
                IsCompleted = true
            };

            await Mediator.SendAsync(command);

            NotificationService.NotifySuccess("Success", "Todo marked as complete");

            await LoadTodos();
        }
        catch (Exception ex)
        {
            NotificationService.NotifyError("Error", $"Failed to update todo: {ex.Message}");
        }
    }

    private void EditTodo(TodoDto todo)
    {
        Navigation.NavigateTo($"/todos/edit/{todo.Id}");
    }

    /// <summary>
    /// Deletes a todo using CQRS command through mediator after confirmation.
    /// </summary>
    private async Task DeleteTodo(TodoDto todo)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete '{todo.Title}'?",
            "Confirm Delete",
            new ConfirmOptions { OkButtonText = "Yes, Delete", CancelButtonText = "Cancel" }
        );

        if (confirmed == true)
        {
            try
            {
                // CQRS: Create and execute delete command through mediator
                var command = new DeleteTodoCommand(todo.Id);
                await Mediator.SendAsync(command);

                NotificationService.NotifySuccess("Deleted", "Todo deleted successfully");

                await LoadTodos();
            }
            catch (Exception ex)
            {
                NotificationService.NotifyError("Error", $"Failed to delete todo: {ex.Message}");
            }
        }
    }

    private string GetPriorityBadgeClass(string priority)
    {
        return priority switch
        {
            "High" => "bg-danger",
            "Medium" => "bg-warning text-dark",
            "Low" => "bg-success",
            _ => "bg-secondary"
        };
    }
}
